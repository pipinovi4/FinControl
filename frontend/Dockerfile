# ---------- BUILD ----------
FROM node:22-alpine AS build

WORKDIR /app

# 1Ô∏è‚É£ –ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –±—ñ–ª–¥—É
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# 2Ô∏è‚É£ –ö–µ—à –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
COPY package*.json ./
RUN npm install

# 3Ô∏è‚É£ –ö–æ–ø—ñ—é—î–º–æ public –î–û build
COPY public ./public

# 4Ô∏è‚É£ –ö–æ–ø—ñ—é—î–º–æ —Ä–µ—à—Ç—É –∫–æ–¥—É
COPY . .

ENV NODE_ENV=production

# üß† DEBUG: –ø–æ–∫–∞–∂–µ–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ –±—ñ–ª–¥—ñ
RUN echo "üåç Building frontend with NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL"

# 5Ô∏è‚É£ –°—Ç–µ–Ω–¥–∞–ª–æ—É–Ω –±—ñ–ª–¥
RUN npm run build


# ---------- RUNTIME ----------
FROM node:22-alpine AS runtime

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

# –ö–æ–ø—ñ—é—î–º–æ standalone —Å–µ—Ä–≤–µ—Ä (–≤–∫–ª—é—á–∞—î node_modules)
COPY --from=build /app/.next/standalone ./

# –ö–æ–ø—ñ—é—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏ (–¥–ª—è –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)
COPY --from=build /app/.next/static ./.next/static

# –ö–æ–ø—ñ—é—î–º–æ public
COPY --from=build /app/public ./public

EXPOSE 3000

CMD ["node", "server.js"]
